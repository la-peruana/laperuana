<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Peruana — Tienda Online</title>
  <meta name="description" content="E-commerce sin backend — La Peruana" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e2e8f0; --muted:#94a3b8;
      --primary:#22c55e; --primary-600:#16a34a;
      --shadow:0 10px 30px rgba(0,0,0,.30);
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--bg) 70%, transparent);
      display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.3px;
    }
    .logo img{ width:36px; height:36px; object-fit:contain; border-radius:8px }
    .grow{ flex:1 }
    .toolbar{ display:flex; gap:8px; align-items:center }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      background: var(--card); color: var(--text);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 12px; border-radius:12px; cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn:hover{ transform: translateY(-1px); }
    main{ max-width:1200px; margin:22px auto; padding: 0 16px 40px }
    #status{
      margin:8px 0 14px; color:var(--muted); font-size:.95rem;
      display:flex; align-items:center; gap:8px;
    }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px }
    section{ margin: 18px 0 28px }
    section h2{ margin: 6px 4px 12px; font-size:1.05rem; color:var(--muted) }

    article.card{
      background:var(--card); color:var(--text); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow:hidden; border:1px solid rgba(255,255,255,.06);
      display:flex; flex-direction:column; min-height: 320px;
    }
    .media{ width:100%; height:200px; background:#0b1220; overflow:hidden }
    .media img{ width:100%; height:100%; object-fit:cover; display:block }
    .content{ padding:12px }
    .title{ margin:4px 0 2px; font-size:1rem; font-weight:700; line-height:1.25 }
    .subtitle{ color:var(--muted); font-size:.9rem }
    .price{ margin-top:8px; font-weight:800 }
    .link{
      margin: 10px 12px 14px; display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px; background: color-mix(in oklab, var(--primary) 86%, black 0%);
      color:#052e14; font-weight:700; text-decoration:none; justify-content:center;
    }
    .link:hover{ filter:brightness(.95) }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }

    /* Skeleton loader */
    .skeleton{
      animation: pulse 1.2s infinite ease-in-out;
      background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.08), rgba(255,255,255,.04));
      background-size: 200% 100%;
    }
    @keyframes pulse{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  </style>
</head>

<body>
<header>
  <div class="logo">
    <img id="lpLogo" src="./assets/la-peruana-logo.png" alt="La Peruana" />
    <div>La Peruana — Tienda Online</div>
  </div>
  <div class="grow"></div>
  <div class="toolbar">
    <button id="themeBtn" class="btn" type="button" title="Cambiar tema">
      <i class="fa-solid fa-circle-half-stroke"></i> Tema
    </button>
    <button id="reloadBtn" class="btn" type="button" title="Recargar catálogo">
      <i class="fa-solid fa-rotate-right"></i> Recargar
    </button>
  </div>
</header>

  <main>
    <div id="status"><i class="fa-solid fa-cloud-arrow-down"></i> Cargando catálogo…</div>
    <div id="catalogo"></div>
  </main>

  <script>
  ;(() => {
    // ========= CONFIG =========
    const SHEET_ID = '1CQGnxb4l_9dLQzcLngSeCfyDKJRv7bem'; // Tu Google Sheet
    const GID      = '1645617335';                         // Pestaña del catálogo
    const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

    // Columnas (0-based)
    // A=Sector, B=Producto, C=Presentación, D=Precio, E=(libre), F=Imagen(URL), G=Link (opcional)
    const COL = {
      sector: 0,
      nombre: 1,
      presentacion: 2,
      precio: 3,
      imagen: 5,
      link: 6
    };

    // ========= HELPERS =========
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const html = (strings, ...vals) => strings.reduce((a,s,i)=> a + s + (vals[i] ?? ''), '');

    function parseCSV(str) {
      // Parser robusto simple (comillas y comas)
      const lines = str.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
      return lines.map(line => {
        const out = [];
        let cur = '', inQuotes = false;
        for (let i=0; i<line.length; i++){
          const ch = line[i], nx = line[i+1];
          if (ch === '"' && inQuotes && nx === '"'){ cur+='"'; i++; continue; }
          if (ch === '"'){ inQuotes = !inQuotes; continue; }
          if (ch === ',' && !inQuotes){ out.push(cur.trim()); cur=''; continue; }
          cur += ch;
        }
        out.push(cur.trim());
        return out;
      });
    }

    const isHttpUrl = (u) => /^https?:\/\//i.test(u || '');
    const money = (n) => {
      const v = String(n).replace(/\./g,'').replace(',','.');
      const num = Number(v);
      return isFinite(num) ? num.toLocaleString('es-AR',{ style:'currency', currency:'ARS', maximumFractionDigits:0 }) : (n || '');
    };

    function skeletonCard(){
      return html`
        <article class="card">
          <div class="media skeleton"></div>
          <div class="content">
            <div class="skeleton" style="height:16px; width:70%; border-radius:8px;"></div>
            <div class="skeleton" style="height:14px; width:45%; border-radius:8px; margin-top:8px;"></div>
            <div class="skeleton" style="height:18px; width:35%; border-radius:8px; margin-top:12px;"></div>
          </div>
        </article>
      `;
    }

    function cardItem(row){
      const nombre       = row[COL.nombre] || 'Producto';
      const presentacion = row[COL.presentacion] || '';
      const precio       = row[COL.precio] || '';
      const imgUrl       = row[COL.imagen];
      const link         = row[COL.link];

      const safeImg = isHttpUrl(imgUrl) ? imgUrl : 'https://via.placeholder.com/640x420?text=Sin+Imagen';
      const hasLink = isHttpUrl(link);

      const media = html`
        <div class="media">
          ${hasLink
            ? html`<a href="${link}" target="_blank" rel="noopener noreferrer"><img src="${safeImg}" alt="${nombre}" loading="lazy"></a>`
            : html`<img src="${safeImg}" alt="${nombre}" loading="lazy">`
          }
        </div>
      `;
      const title = html`<div class="title">${nombre}</div>`;
      const sub   = presentacion ? html`<div class="subtitle">${presentacion}</div>` : '';
      const prc   = precio ? html`<div class="price">${money(precio)}</div>` : '';

      const action = hasLink
        ? html`<a class="link" href="${link}" target="_blank" rel="noopener noreferrer">
                 <i class="fa-solid fa-cart-shopping"></i> Comprar
               </a>`
        : '';

      return html`
        <article class="card">
          ${media}
          <div class="content">
            ${title}
            ${sub}
            ${prc}
          </div>
          ${action}
        </article>
      `;
    }

    function renderBySector(rows){
      const host = $('#catalogo');
      if (!host){ console.warn('No se encontró #catalogo'); return; }

      // Agrupar por sector
      const groups = rows.reduce((acc, r) => {
        const k = r[COL.sector] || 'General';
        (acc[k] ||= []).push(r);
        return acc;
      }, {});

      host.innerHTML = Object.entries(groups).map(([sector, arr]) => html`
        <section>
          <h2>${sector}</h2>
          <div class="grid">
            ${arr.map(cardItem).join('')}
          </div>
        </section>
      `).join('');
    }

    function maybeHasHeader(row0){
      const a = (row0?.[COL.nombre] || '').toLowerCase();
      return a.includes('producto') || a.includes('nombre');
    }

    async function loadCatalog(force = false){
      const status = $('#status');
      const host   = $('#catalogo');

      // Loader
      status.innerHTML = `<i class="fa-solid fa-cloud-arrow-down"></i> Cargando catálogo…`;
      host.innerHTML = `<div class="grid">${Array.from({length:8}).map(skeletonCard).join('')}</div>`;

      try{
        const bust = force ? `&v=${Date.now()}` : '';
        const res = await fetch(CSV_URL + bust, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const rows = parseCSV(text);

        const body = maybeHasHeader(rows[0]) ? rows.slice(1) : rows;
        const clean = body.filter(r => (r[COL.nombre] || '').trim().length);

        if (!clean.length) {
          status.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> No hay filas válidas (verificá columnas B/C/D/F y permisos del Sheet).`;
          host.innerHTML = '';
          return;
        }

        renderBySector(clean);
        status.innerHTML = `<i class="fa-solid fa-circle-check"></i> Catálogo actualizado — ${new Date().toLocaleString('es-AR')}`;
      } catch (err){
        console.error(err);
        status.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Error cargando catálogo: ${String(err.message || err)}`;
        host.innerHTML = `<div style="color:#ef4444">Verificá:
          <ul>
            <li>Que la planilla sea pública o “cualquiera con el enlace”.</li>
            <li>Que el <b>ID</b> y <b>gid</b> sean correctos.</li>
            <li>Que la columna <b>F</b> tenga URLs de imagen válidas.</li>
          </ul></div>`;
      }
    }

    // ========= THEME / UX =========
    function toggleTheme(){
      const root = document.documentElement;
      const cur  = root.getAttribute('data-theme') || 'dark';
      const nxt  = cur === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', nxt);
      try{ localStorage.setItem('lp-theme', nxt) }catch{}
    }
    function restoreTheme(){
      let t = 'dark';
      try{ t = localStorage.getItem('lp-theme') || t }catch{}
      document.documentElement.setAttribute('data-theme', t);
    }

    // ========= INIT =========
    document.addEventListener('DOMContentLoaded', () => {
      restoreTheme();
      $('#themeBtn')?.addEventListener('click', toggleTheme);
      $('#reloadBtn')?.addEventListener('click', () => loadCatalog(true));
      loadCatalog(false);
    });
  })();
  </script>
</body>
</html>
