<script>
;(() => {
  // ========= CONFIG =========
  const SHEET_ID = '1CQGnxb4l_9dLQzcLngSeCfyDKJRv7bem';
  const GID      = '1645617335';
  const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

  // Columnas (0-based): A=Sector, B=Producto, C=Presentación, D=Precio, E=(libre), F=Imagen, G=Link
  const COL = { sector:0, nombre:1, presentacion:2, precio:3, imagen:5, link:6 };

  // Orden “de negocio” (ajustalo a tu gusto)
  const ORDER = [
    'Ofertas', 'Carnicería', 'Verdulería', 'Panadería', 'Pastelería', 'Rotisería',
    'Almacén', 'Café', 'Bebidas', 'Lácteos', 'Quesos', 'Fiambres',
    'Congelados', 'Higiene', 'Limpieza', 'Mascotas', 'Bazar', 'General'
  ];

  // ========= HELPERS =========
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const html = (s, ...v) => s.reduce((a,b,i)=> a + b + (v[i] ?? ''), '');

  // Quita tildes/ruido para comparar
  const fold = (s) => String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // sin tildes
    .toLowerCase()
    .replace(/[^\p{L}\p{N}]+/gu,' ') // no letras/números -> espacio
    .trim();

  // Canonización con sinónimos
  function canonicalSector(raw){
    const t = fold(raw);
    if (!t) return 'General';

    const RULES = [
      [/\boferta(s)?\b/,                    'Ofertas'],
      [/\b(carniceria|carne(s)?|vacio|asado|milanesa|pollo|aves?|cerdo|porcino)\b/, 'Carnicería'],
      [/\b(verduleria|verdura(s)?|fruta(s)?|vegetal(es)?|hortaliza(s)?)\b/,        'Verdulería'],
      [/\b(panaderia|pan(es)?|factura(s)?)\b/,                                     'Panadería'],
      [/\b(pasteleria|reposteria|torta(s)?|postre(s)?)\b/,                          'Pastelería'],
      [/\b(rotiseria|plato(s)? preparado(s)?|comida(s)? lista(s)?|cocina)\b/,       'Rotisería'],
      [/\b(almacen|almacen|despensa|kiosco|kiosko|kiosk?o)\b/,                      'Almacén'],
      [/\b(cafe|cafeteria|cafe(s)?)\b/,                                            'Café'],
      [/\b(bebida(s)?|bodega|vino(s)?|cerveza(s)?|gaseosa(s)?)\b/,                  'Bebidas'],
      [/\b(lacteos?|leche|yogur?|manteca|huevo(s)?)\b/,                             'Lácteos'],
      [/\b(fiambre(s)?|fiambreria|fiambreria)\b/,                                   'Fiambres'],
      [/\b(queso(s)?)\b/,                                                           'Quesos'],
      [/\b(congelado(s)?|freezer|frozen)\b/,                                        'Congelados'],
      [/\b(limpieza|hogar)\b/,                                                      'Limpieza'],
      [/\b(higiene|perfumeria)\b/,                                                  'Higiene'],
      [/\b(mascota(s)?|pet)\b/,                                                     'Mascotas'],
      [/\b(bazar|hogar y bazar)\b/,                                                 'Bazar'],
    ];
    for (const [rx, label] of RULES){
      if (rx.test(t)) return label;
    }
    // Si no matchea, devolvemos capitalizado “suave” del original
    const orig = String(raw||'').trim();
    if (!orig) return 'General';
    return orig.charAt(0).toUpperCase() + orig.slice(1);
  }

  // Parser CSV simple (comillas + comas)
  function parseCSV(str){
    const lines = str.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
    return lines.map(line => {
      const out = []; let cur = '', inQuotes = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i], nx = line[i+1];
        if (ch === '"' && inQuotes && nx === '"'){ cur+='"'; i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }
        if (ch === ',' && !inQuotes){ out.push(cur.trim()); cur=''; continue; }
        cur += ch;
      }
      out.push(cur.trim());
      return out;
    });
  }

  const isHttpUrl = (u) => /^https?:\/\//i.test(u || '');
  const money = (n) => {
    const v = String(n).replace(/\./g,'').replace(',','.');
    const num = Number(v);
    return isFinite(num) ? num.toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}) : (n || '');
  };

  function skeletonCard(){
    return html`
      <article class="card">
        <div class="media skeleton"></div>
        <div class="content">
          <div class="skeleton" style="height:16px;width:70%;border-radius:8px;"></div>
          <div class="skeleton" style="height:14px;width:45%;border-radius:8px;margin-top:8px;"></div>
          <div class="skeleton" style="height:18px;width:35%;border-radius:8px;margin-top:12px;"></div>
        </div>
      </article>`;
  }

  function cardItem(row){
    const nombre = row[COL.nombre] || 'Producto';
    const presentacion = row[COL.presentacion] || '';
    const precio = row[COL.precio] || '';
    const imgUrl = row[COL.imagen];
    const link   = row[COL.link];

    const safeImg = isHttpUrl(imgUrl) ? imgUrl : 'https://via.placeholder.com/640x420?text=Sin+Imagen';
    const hasLink = isHttpUrl(link);

    const media = html`
      <div class="media">
        ${hasLink
          ? html`<a href="${link}" target="_blank" rel="noopener noreferrer"><img src="${safeImg}" alt="${nombre}" loading="lazy"></a>`
          : html`<img src="${safeImg}" alt="${nombre}" loading="lazy">`}
      </div>`;
    const title = html`<div class="title">${nombre}</div>`;
    const sub   = presentacion ? html`<div class="subtitle">${presentacion}</div>` : '';
    const prc   = precio ? html`<div class="price">${money(precio)}</div>` : '';

    const action = hasLink
      ? html`<a class="link" href="${link}" target="_blank" rel="noopener noreferrer">
               <i class="fa-solid fa-cart-shopping"></i> Comprar
             </a>` : '';

    return html`
      <article class="card">
        ${media}
        <div class="content">${title}${sub}${prc}</div>
        ${action}
      </article>`;
  }

  // Barra de filtros
  function buildSectorsBar(sectors, onSelect, active='Todos'){
    const bar = $('#sectorsBar');
    if (!bar) return;
    const all = ['Todos', ...sectors];
    bar.innerHTML = all.map(s => {
      const isActive = active === s;
      return `<button class="sector-chip ${isActive?'active':''}" data-sector="${s}">${s}</button>`;
    }).join('');
    bar.querySelectorAll('.sector-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        bar.querySelectorAll('.sector-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        onSelect(btn.dataset.sector);
      });
    });
  }

  // Orden custom por ranking + alfabético de fallback
  const orderIndex = (s) => {
    const i = ORDER.indexOf(s);
    return i === -1 ? 10_000 : i;
  };
  function sortSectors(arr){
    return [...arr].sort((a,b) => {
      const ia = orderIndex(a), ib = orderIndex(b);
      return ia !== ib ? ia - ib : a.localeCompare(b,'es');
    });
  }

  function renderAll(groups, filter='Todos'){
    const host = $('#catalogo');
    if (!host) return;

    const entries = Object.entries(groups);
    // Ordenamos sectores por ranking
    entries.sort((a,b) => {
      const sa = a[0], sb = b[0];
      const ia = orderIndex(sa), ib = orderIndex(sb);
      return ia !== ib ? ia - ib : sa.localeCompare(sb, 'es');
    });

    let out = '';
    if (filter === 'Todos'){
      out = entries.map(([sector, arr]) => `
        <section>
          <h2>${sector}</h2>
          <div class="grid">${arr.map(cardItem).join('')}</div>
        </section>`).join('');
    } else {
      const arr = groups[filter] || [];
      out = `
        <section>
          <h2>${filter}</h2>
          <div class="grid">${arr.map(cardItem).join('')}</div>
        </section>`;
    }
    host.innerHTML = out;
  }

  function maybeHasHeader(row0){
    const a = (row0?.[COL.nombre] || '').toLowerCase();
    return a.includes('producto') || a.includes('nombre');
  }

  async function loadCatalog(force=false){
    const status = $('#status');
    const host   = $('#catalogo');
    status.innerHTML = `<i class="fa-solid fa-cloud-arrow-down"></i> Cargando catálogo…`;
    host.innerHTML   = `<div class="grid">${Array.from({length:8}).map(skeletonCard).join('')}</div>`;

    try{
      const bust = (CSV_URL.includes('?') ? '&' : '?') + 'v=' + Date.now(); // anti-cache
      const res  = await fetch(CSV_URL + bust, { cache:'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();

      // Si Google devolvió HTML (no público)
      if (/<\s*html[\s>]/i.test(text)){
        status.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> La planilla no es pública. Cambiá a "Cualquiera con el enlace (Lector)".`;
        host.innerHTML = '';
        return;
      }

      const rows = parseCSV(text);
      const body = maybeHasHeader(rows[0]) ? rows.slice(1) : rows;

      // Normalizamos sector y filtramos filas válidas
      const rawToCanon = new Map();
      const clean = body
        .filter(r => (r[COL.nombre] || '').trim().length)
        .map(r => {
          const raw = r[COL.sector];
          const canon = canonicalSector(raw);
          rawToCanon.set(String(raw||'').trim(), canon);
          r[COL.sector] = canon;
          return r;
        });

      if (!clean.length){
        status.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> No hay filas válidas (revisá columnas A/B/C/D/F).`;
        host.innerHTML = '';
        return;
      }

      // Agrupar
      const groups = clean.reduce((acc, r) => {
        (acc[r[COL.sector]] ||= []).push(r);
        return acc;
      }, {});

      // Sectores presentes y ordenados
      const sectors = sortSectors(Object.keys(groups));

      // Barra + render
      buildSectorsBar(sectors, (selected) => renderAll(groups, selected), 'Todos');
      renderAll(groups, 'Todos');

      status.innerHTML = `<i class="fa-solid fa-circle-check"></i> Catálogo actualizado — ${new Date().toLocaleString('es-AR')}`;

      // Auditoría útil en consola
      console.table([...rawToCanon.entries()].map(([raw, canon]) => ({RAW: raw || '(vacío)', CANONICO: canon})));
    } catch (err){
      console.error(err);
      status.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Error cargando catálogo: ${String(err.message || err)}`;
      host.innerHTML = '';
    }
  }

  // ========= THEME / UX =========
  function toggleTheme(){
    const root = document.documentElement;
    const cur  = root.getAttribute('data-theme') || 'dark';
    const nxt  = cur === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', nxt);
    try{ localStorage.setItem('lp-theme', nxt) }catch{}
  }
  function restoreTheme(){
    let t = 'dark';
    try{ t = localStorage.getItem('lp-theme') || t }catch{}
    document.documentElement.setAttribute('data-theme', t);
  }

  // ========= INIT =========
  document.addEventListener('DOMContentLoaded', () => {
    restoreTheme();
    $('#themeBtn')?.addEventListener('click', toggleTheme);
    $('#reloadBtn')?.addEventListener('click', () => loadCatalog(true));
    loadCatalog(false);
  });
})();
</script>
