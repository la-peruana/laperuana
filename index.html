<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Peruana ‚Äî Tienda Online</title>
  <meta name="description" content="E-commerce sin backend ‚Äî Tienda online de La Peruana" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e2e8f0; --primary:#22c55e; --primary-600:#16a34a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px; }
    [data-theme="light"]{ --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --text:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.10); }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:rgba(15,23,42,.75);border-bottom:1px solid rgba(148,163,184,.15)}
    [data-theme="light"] header{background:rgba(255,255,255,.9)}
    .h-in{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .brand-logo{height:40px;width:auto;object-fit:contain;border-radius:8px}
    .search{position:relative;flex:1;min-width:260px;max-width:520px}
    .search input{width:100%;padding:12px 42px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text)}
    [data-theme="light"] .search input{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .search i{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .toggle,.btn-lite{border:1px solid rgba(148,163,184,.25);padding:8px 10px;border-radius:999px;display:inline-flex;gap:8px;align-items:center;cursor:pointer;background:#0b1220;color:var(--text)}
    [data-theme="light"] .toggle,[data-theme="light"] .btn-lite{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .btn.primary{background:var(--primary);border-color:transparent;color:#052e14;font-weight:700}
    .layout{max-width:1200px;margin:0 auto;padding:16px;display:grid;grid-template-columns:260px 1fr;gap:16px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} }
    .side{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .cats button{width:100%;text-align:left;margin-bottom:6px;padding:10px;border-radius:12px;border:1px solid rgba(148,163,184,.2);background:#0b1220;color:var(--text);cursor:pointer}
    [data-theme="light"] .cats button{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .cats button.active{border-color:var(--primary)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
    .toolbar select, .toolbar input{padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text)}
    [data-theme="light"] .toolbar select, [data-theme="light"] .toolbar input{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .thumb{height:90px;background:linear-gradient(135deg, rgba(34,197,94,.12), rgba(6,182,212,.12));display:grid;place-items:center;color:#a7f3d0;font-size:32px}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .info{padding:12px;display:flex;flex-direction:column;gap:6px}
    .name{font-weight:900;line-height:1.15} .unit{font-size:12px;color:var(--muted)} .price{font-weight:900}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:auto}
    .btn{border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
    [data-theme="light"] .btn{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .qty{display:flex;gap:6px;align-items:center}
    .qty .icon{width:34px;height:34px;display:grid;place-items:center;border:1px solid rgba(148,163,184,.25);border-radius:8px;cursor:pointer;background:#0b1220;color:var(--text)}
    [data-theme="light"] .qty .icon{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .cartbar{position:sticky;bottom:0;background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border-top:1px solid rgba(148,163,184,.2);padding:8px 16px;z-index:10}
    [data-theme="light"] .cartbar{background:rgba(255,255,255,.95)}
    .cartbar .inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .checkout{max-width:900px;margin:20px auto;background:var(--card);border:1px solid rgba(148,163,184,.2);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} @media(max-width:700px){ .row{grid-template-columns:1fr} }
    .field, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text)}
    [data-theme="light"] .field, [data-theme="light"] select{background:#fff;border-color:#e2e8f0;color:#0f172a}
    .summary{margin-top:12px;padding:12px;border-radius:10px;background:#0b1220;border:1px solid rgba(148,163,184,.2)}
    [data-theme="light"] .summary{background:#f8fafc;border-color:#e2e8f0}
    .line{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(148,163,184,.2)}
    .toast{position:fixed;right:12px;bottom:12px;background:#052e16;color:#bbf7d0;border:1px solid #166534;padding:10px 12px;border-radius:10px;display:none;z-index:1000}
    .toast.show{display:block}
  </style>

  <style>
    /* Overlay de texto SOLO en modo claro */
    [data-theme="light"] .card { display: grid; }
    [data-theme="light"] .thumb, [data-theme="light"] .info { grid-area: 1 / 1; }
    [data-theme="light"] .thumb { position: relative; height: 180px; overflow: hidden; }
    [data-theme="light"] .thumb::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,.60), rgba(0,0,0,0)); z-index: 0; }
    [data-theme="light"] .thumb img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
    [data-theme="light"] .info { position: relative; z-index: 1; align-self: end; padding: 12px; gap: 6px; }
    [data-theme="light"] .info .name, [data-theme="light"] .info .unit, [data-theme="light"] .info .price {
      color: var(--text) !important;
      text-shadow: 0 1px 2px rgba(255,255,255,.25), 0 0 1px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
  <header>
    <div class="h-in">
      <div class="brand">
        <img src="LOGO-LA-PERUANA.jpg" alt="La Peruana" class="brand-logo">
        <strong>La Peruana</strong>
      </div>
      <div class="search">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="q" placeholder="Buscar (ej: medialuna, sandwich, queso‚Ä¶)">
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-lite" id="btnConnectSheets"><i class="fa-solid fa-plug"></i> Conectar Sheets</button>
        <button class="btn-lite" id="btnSync"><i class="fa-solid fa-rotate"></i> Actualizar cat√°logo</button>
        <div class="toggle" id="themeToggle" title="Cambiar tema"><i class="fa-solid fa-moon"></i> <span id="themeLabel">Oscuro</span></div>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="side">
      <h3>Categor√≠as</h3>
      <div id="cats" class="cats"></div>
      <hr style="border-color:rgba(148,163,184,.2)">
      <h3>Filtros</h3>
      <div class="toolbar">
        <select id="sort">
          <option value="relevance">Ordenar: Relevancia</option>
          <option value="price_asc">Precio ‚Üë</option>
          <option value="price_desc">Precio ‚Üì</option>
          <option value="alpha">A‚ÄìZ</option>
        </select>
        <input id="minp" class="field" placeholder="Precio min">
        <input id="maxp" class="field" placeholder="Precio max">
        <button class="btn" id="apply">Aplicar</button>
        <button class="btn" id="clear">Limpiar</button>
      </div>
    </aside>

    <main>
      <div class="grid" id="grid"></div>
    </main>
  </div>

  <div class="cartbar">
    <div class="inner">
      <div><strong id="cartCount">0 √≠tems</strong></div>
      <div style="display:flex;align-items:center;gap:10px">
        <strong id="cartTotal">$0</strong>
        <button class="btn" id="btnClearCartBar">Limpiar carrito</button>
        <a href="#checkout" class="btn primary">Ir al checkout</a>
      </div>
    </div>
  </div>

  <section id="checkout" class="checkout">
    <h2>Checkout</h2>
    <div class="row">
      <div>
        <label>Nombre y apellido</label>
        <input id="f_name" class="field" autocomplete="name">
      </div>
      <div>
        <label>Email</label>
        <input id="f_email" class="field" autocomplete="email">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Tel√©fono</label>
        <input id="f_phone" class="field" autocomplete="tel">
      </div>
      <div>
        <label>Modo de entrega</label>
        <select id="f_mode">
          <option value="delivery">Delivery</option>
          <option value="pickup">Retiro en local</option>
        </select>
      </div>
    </div>
    <div class="row" id="rowAddress">
      <div>
        <label>Direcci√≥n</label>
        <input id="f_address" class="field" placeholder="Calle, n√∫mero, depto, referencias">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Pago</label>
        <select id="f_payment" class="field">
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia</option>
          <option value="mercadopago">Mercado Pago</option>
        </select>
      </div>
      <div>
        <label>Cup√≥n</label>
        <input id="f_coupon" class="field" placeholder="BIENVENIDO10">
      </div>
    </div>

    <div class="summary">
      <div class="line"><span>Subtotal</span><strong id="sum_sub">$0</strong></div>
      <div class="line"><span>Env√≠o</span><strong>Se cotizar√° seg√∫n el volumen del pedido y la zona</strong></div>
      <div class="line"><span>Descuentos</span><strong id="sum_disc">-$0</strong></div>
      <div class="line" style="border-bottom:0"><span>Total</span><strong id="sum_total">$0</strong></div>
    </div>

    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="btnClearCart">Limpiar carrito</button>
      <button class="btn primary" id="btnConfirm">Confirmar pedido</button>
    </div>

    <p id="payHints" style="color:var(--muted);font-size:12px;margin-top:8px"></p>
    <div id="orderOk" style="display:none;margin-top:12px" class="summary">‚úÖ Pedido confirmado. Abrimos WhatsApp con tu orden.</div>
  </section>

  <div class="toast" id="toast">Agregado al carrito</div>

  <script>
// === IM√ÅGENES DESDE GITHUB PAGES ===
const GITHUB_USER = "la-peruana";          // tu organizaci√≥n/usuario
const GITHUB_REPO = "laperuana";           // repo correcto
const GITHUB_BRANCH = "main";              // rama que publica
const GITHUB_PAGES_BASE = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}/`;
const DEFAULT_IMG_DIR = "assets/img/";     // carpeta de im√°genes dentro del repo

    // ====== CONSTANTES Y HELPERS ======
    const PLACEHOLDER_IMG = "https://via.placeholder.com/640x420?text=La+Peruana";

    // Limpia a entero ARS
    const toARS = (x) => {
      if (typeof x === 'number' && isFinite(x)) return Math.round(x);
      const s = String(x ?? '').replace(/[^\d]/g, '');
      return s ? Math.round(Number(s)) : 0;
    };
    const fmt = (n)=> toARS(n).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0});
    const slug = (s)=> String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    const toast = (msg) => {
      const t=document.getElementById("toast");
      t.textContent=msg; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),1500);
    };

    // === CONFIG ===
    const WHATSAPP_NUMBER = "+5493435075991";
    const DEFAULT_SHEET_ID = "1CQGnxb4l_9dLQzcLngSeCfyDKJRv7bem";
    const DEFAULT_GID = "1645617335";

    // URL GVIZ por defecto o guardada
    let SHEETS_GVIZ_URL =
      localStorage.getItem("sheets_gviz_url") ||
      `https://docs.google.com/spreadsheets/d/${DEFAULT_SHEET_ID}/gviz/tq?tqx=out:json&gid=${DEFAULT_GID}`;

    // Normaliza cualquier URL a GVIZ
    function normalizeSheetsUrl(u) {
      if (!u) return "";
      try {
        const url = new URL(u);
        if (url.pathname.includes("/gviz/tq")) return u;
        const m = url.pathname.match(/\/d\/([a-zA-Z0-9-_]+)/);
        const id = m?.[1];
        // Soporta enlaces "edit" y "view" con gid; tambi√©n sheet=
        const gid = url.searchParams.get("gid") || (/gid=(\d+)/.exec(u)?.[1] ?? "");
        const sheet = url.searchParams.get("sheet") || "";
        if (id) {
          const base = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json`;
          if (gid) return `${base}&gid=${gid}`;
          if (sheet) return `${base}&sheet=${encodeURIComponent(sheet)}`;
          // fallback a la primera hoja (si no hay gid/sheet)
          return `${base}`;
        }
      } catch {}
      return u;
    }

    // Normalizador robusto de URLs (Drive + gen√©ricas)
    function normalizeImageUrl(u) {
  if (!u) return "";
  u = String(u).trim();

  // A) Si viene absoluta http/https
  if (/^https?:\/\//i.test(u)) {
    // 1) github.com/.../blob/...  -> raw.githubusercontent.com/...
    let m = u.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.+)$/i);
    if (m) {
      const [, user, repo, branch, path] = m;
      u = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }

    // 2) github.com/.../raw/... -> raw.githubusercontent.com/...
    m = u.match(/^https?:\/\/github\.com\/([^\/]+)\/([^\/]+)\/raw\/([^\/]+)\/(.+)$/i);
    if (m) {
      const [, user, repo, branch, path] = m;
      u = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}`;
    }

    // 3) raw.githubusercontent.com/{user}/{repo}/{branch}/{path} -> PAGES
    m = u.match(/^https?:\/\/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)$/i);
    if (m) {
      const [, user, repo, branch, path] = m;
      return `https://${user}.github.io/${repo}/${path}`;
    }

    // 4) Si ya es Pages u otra URL https v√°lida, devolver tal cual
    return u.replace(/^http:/i, "https:");
  }

  // B) Si NO es absoluta: permitir ruta relativa o solo nombre
  const isPath = /[\/\]/.test(u);
  const path = isPath ? u.replace(/^\.?\/*/, "") : (DEFAULT_IMG_DIR + u);
  return GITHUB_PAGES_BASE + path;
}
`;
        return u;
      }
      return ""; // nombres sueltos => inv√°lidos para web est√°tica
    }

    const Categories = [
      { id:"rotiseria", name:"Rotiser√≠a", icon:"fa-utensils" },
      { id:"panaderia", name:"Panader√≠a", icon:"fa-bread-slice" },
      { id:"pasteleria", name:"Pasteler√≠a", icon:"fa-cake-candles" },
      { id:"carniceria", name:"Carnicer√≠a", icon:"fa-drumstick-bite" },
      { id:"verduleria", name:"Verduler√≠a", icon:"fa-carrot" },
      { id:"fiambreria", name:"Fiambrer√≠a", icon:"fa-cheese" },
      { id:"almacen", name:"Almac√©n", icon:"fa-boxes-stacked" },
      { id:"bebidas", name:"Bebidas", icon:"fa-champagne-glasses" },
      { id:"cafeteria", name:"Cafeter√≠a", icon:"fa-mug-saucer" }
    ];

    // Cat√°logo de respaldo (si Sheet falla)
    let Catalog = {
      rotiseria:[{ name:"Torrejas de arroz", price:1225, unit:"x 3 unidades", image: PLACEHOLDER_IMG }],
      panaderia:[{ name:"Medialunas dulces", price:1851, unit:"x 3 unidades", image: PLACEHOLDER_IMG }],
      pasteleria:[{ name:"Cheese cake individual", price:6362, unit:"unidad", image: PLACEHOLDER_IMG }],
      carniceria:[{ name:"Milanesa de carne", price:13500, unit:"kg", image: PLACEHOLDER_IMG }],
      verduleria:[{ name:"Zanahorias", price:984, unit:"kg", image: PLACEHOLDER_IMG }],
      fiambreria:[{ name:"Bandeja Picada Lario x 700 grs", price:15681, unit:"bandeja", image: PLACEHOLDER_IMG }],
      almacen:[{ name:"Arroz Gallo oro", price:2909, unit:"x 1 kg", image: PLACEHOLDER_IMG }],
      bebidas:[{ name:"Coca Cola 1.5L", price:3810, unit:"botella", image: PLACEHOLDER_IMG }],
      cafeteria:[{ name:"Caf√© con leche + croissant", price:4473, unit:"Combo", image: PLACEHOLDER_IMG }]
    };

    const State = { theme: localStorage.getItem("shop_theme") || "dark", cat: Categories[0].id, q:"", sort:"relevance", minp:"", maxp:"" };

    const Cart = {
      key:"shop_cart_v1",
      data: {},
      load(){ try{ this.data = JSON.parse(localStorage.getItem(this.key)) || {} }catch{ this.data = {} }; UI.sync() },
      save(){ localStorage.setItem(this.key, JSON.stringify(this.data)); UI.sync() },
      add(p){
        const id=slug(p.name);
        const safe = { ...p, price: toARS(p.price) };
        if(!this.data[id]) this.data[id]={...safe, qty:0};
        this.data[id].qty++;
        this.data[id].price = toARS(this.data[id].price);
        this.save(); toast("Agregado");
      },
      dec(id){ if(!this.data[id]) return; this.data[id].qty--; if(this.data[id].qty<=0) delete this.data[id]; this.save() },
      set(id,q){
        if(q<=0){ delete this.data[id]; this.save(); return; }
        if(this.data[id]){ this.data[id].qty=q; this.data[id].price = toARS(this.data[id].price); this.save(); }
      },
      clear(){ this.data={}; this.save() },
      items(){ return Object.values(this.data) },
      count(){ return this.items().reduce((a,b)=>a+b.qty,0) },
      subtotal(){ return this.items().reduce((a,b)=> a + toARS(b.price)*b.qty, 0) }
    };

    const Data = {
      overrideFromQuery(){
        try{
          const u=new URL(location.href);
          const s=u.searchParams.get("sheets");
          if(s){
            const norm = normalizeSheetsUrl(s);
            SHEETS_GVIZ_URL = norm;
            localStorage.setItem("sheets_gviz_url", norm);
          }
        }catch{}
      },
      async loadFromSheets() {
        if(!SHEETS_GVIZ_URL) return;
        try{
          const url = normalizeSheetsUrl(SHEETS_GVIZ_URL);
          const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now(); // anti-cache
          const res = await fetch(url + bust, { cache:"no-store" });
          const text = await res.text();

          // Si vino HTML (no p√∫blico o link incorrecto) -> restaurar default y reintentar 1 vez
          if (/<\s*html[\s>]/i.test(text)) {
            toast("Sheet no p√∫blico o URL incorrecta. Restauro URL por defecto.");
            console.warn("Respuesta HTML en vez de GVIZ JSON. Restaurando default.");
            SHEETS_GVIZ_URL = `https://docs.google.com/spreadsheets/d/${DEFAULT_SHEET_ID}/gviz/tq?tqx=out:json&gid=${DEFAULT_GID}`;
            localStorage.setItem("sheets_gviz_url", SHEETS_GVIZ_URL);
            return Data.loadFromSheets();
          }

          // Extrae JSON de setResponse(...) de forma robusta
          const m = text.match(/setResponse\(\s*([\s\S]*?)\s*\)\s*;?\s*$/);
          if(!m) throw new Error("GVIZ: formato inesperado");
          const json = JSON.parse(m[1]);
          const rows = json.table?.rows || [];

          const tmp = {}; for(const c of Categories) tmp[c.id]=[];

          for(const r of rows){
            const c = r.c || [];

            // HOJA: A=Categor√≠a, B=Nombre, C=Unidad, D=Precio, E=Imagen, (F opcional=Imagen)
            const category = (c[0]?.v||"").toString().trim();
            const name     = (c[1]?.v||"").toString().trim();
            if(!name) continue; // salteo filas vac√≠as
            const unit     = (c[2]?.v||"").toString().trim();

            const rawPrice = c[3]?.v;
            const price    = (typeof rawPrice === 'number') ? Math.round(rawPrice) : toARS(rawPrice);

            const rawImageE = (c[4]?.v||"").toString().trim();
            const rawImageF = (c[5]?.v||"").toString().trim();
            const rawImage  = rawImageE || rawImageF;
            const img = normalizeImageUrl(rawImage) || PLACEHOLDER_IMG;

            // Normalizaci√≥n de categor√≠a
            const n = category.toLowerCase();
            let id="almacen";
            if(n.includes("cafeter")) id="cafeteria";
            else if(n.includes("rotis")) id="rotiseria";
            else if(n.includes("panad")) id="panaderia";
            else if(n.includes("pastel")) id="pasteleria";
            else if(n.includes("carnic")) id="carniceria";
            else if(n.includes("verdul")) id="verduleria";
            else if(n.includes("fiambr")||n.includes("queso")||n.includes("charcut")) id="fiambreria";
            else if(n.includes("bebid")||n.includes("cerve")||n.includes("gaseosa")) id="bebidas";

            tmp[id].push({ name, unit, price, image: img });
          }

          let imported = 0; for(const k in tmp) imported += tmp[k].length;
          if(imported>0) { Catalog = tmp; UI.grid(); toast(`Cat√°logo actualizado (${imported} √≠tems)`); }
          else { toast("Sheet vac√≠o o columnas sin datos: mantengo cat√°logo local"); }
        }catch(e){
          console.error(e); toast("No se pudo cargar el Sheet: mantengo cat√°logo local");
        }
      }
    };

    const UI = {
      init(){
        // tema
        document.documentElement.setAttribute("data-theme", State.theme);
        const lbl = document.getElementById("themeLabel"); if(lbl) lbl.textContent = State.theme==="dark" ? "Oscuro" : "Claro";

        // URL por query ?sheets=...
        Data.overrideFromQuery();

        // UI + datos locales
        this.cats(); this.grid(); this.bind(); Cart.load(); this.checkoutSync();

        // info inicial
        const initial = Object.values(Catalog).reduce((a,b)=>a+(b?.length||0),0);
        toast("Cat√°logo: "+initial+" √≠tems");

        // intentar cargar Sheet
        Data.loadFromSheets();
      },
      bind(){
        document.getElementById("themeToggle").onclick = ()=>{
          State.theme = State.theme==="dark" ? "light":"dark";
          localStorage.setItem("shop_theme", State.theme);
          document.documentElement.setAttribute("data-theme", State.theme);
          document.getElementById("themeLabel").textContent = State.theme==="dark" ? "Oscuro" : "Claro";
        };
        document.getElementById("q").oninput = e => { State.q = e.target.value.toLowerCase(); this.grid(); };
        document.getElementById("sort").onchange = e => { State.sort = e.target.value; this.grid(); };
        document.getElementById("apply").onclick = ()=>{ State.minp = document.getElementById("minp").value; State.maxp = document.getElementById("maxp").value; this.grid(); };
        document.getElementById("clear").onclick = ()=>{ State.minp=""; State.maxp=""; document.getElementById("minp").value=""; document.getElementById("maxp").value=""; this.grid(); };
        document.getElementById("f_mode").onchange = ()=> this.checkoutSync();
        document.getElementById("f_payment").onchange = ()=> this.checkoutSync();
        document.getElementById("f_coupon").oninput = ()=> this.checkoutSync();
        document.getElementById("btnConfirm").onclick = ()=> this.confirmOrder();
        document.getElementById("btnClearCartBar").onclick = ()=>{ if(confirm("¬øVaciar todo el carrito?")){ Cart.clear(); toast("Carrito vac√≠o"); } };
        document.getElementById("btnClearCart").onclick = ()=>{ if(confirm("¬øVaciar todo el carrito?")){ Cart.clear(); toast("Carrito vac√≠o"); } };
        document.getElementById("btnSync").onclick = ()=> Data.loadFromSheets();

        document.getElementById("btnConnectSheets").onclick = ()=>{
          const current = localStorage.getItem("sheets_gviz_url") || SHEETS_GVIZ_URL || "";
          const val = prompt("Peg√° el enlace de tu Google Sheet (edit/share/CSV o GVIZ). Yo lo convierto.", current);
          if(val && val.startsWith("https://")){
            const norm = normalizeSheetsUrl(val);
            SHEETS_GVIZ_URL = norm;
            localStorage.setItem("sheets_gviz_url", norm);
            toast("Sheets conectado. Actualizando cat√°logo‚Ä¶");
            Data.loadFromSheets();
          } else if(val !== null) {
            toast("Enlace inv√°lido. No se guard√≥.");
          }
        };
      },
      cats(){
        const el = document.getElementById("cats"); el.innerHTML="";
        Categories.forEach(c=>{
          const b=document.createElement("button");
          b.className = (State.cat===c.id?"active":"");
          b.innerHTML = `<i class="fa-solid ${c.icon}"></i> ${c.name}`;
          b.onclick=()=>{ State.cat=c.id; this.cats(); this.grid(); };
          el.appendChild(b);
        });
      },
      productsOf(c){ return Catalog[c.id]||[] },
      grid(){
        const wrap = document.getElementById("grid"); if(!wrap) return;
        wrap.innerHTML="";
        const cats = State.q ? Categories : Categories.filter(c=>c.id===State.cat);
        cats.forEach(c=>{
          const list = this.productsOf(c)
            .filter(p=> !State.q || p.name.toLowerCase().includes(State.q))
            .filter(p=> (State.minp? toARS(p.price)>=toARS(State.minp):true) && (State.maxp? toARS(p.price)<=toARS(State.maxp):true))
            .slice();

          if(State.sort==="price_asc") list.sort((a,b)=> toARS(a.price)-toARS(b.price));
          else if(State.sort==="price_desc") list.sort((a,b)=> toARS(b.price)-toARS(a.price));
          else if(State.sort==="alpha") list.sort((a,b)=> a.name.localeCompare(b.name,'es'));

          list.forEach(p=>{
            const key = slug(p.name);
            const card = document.createElement("div"); card.className="card";
            const th = document.createElement("div"); th.className="thumb";
            const img=document.createElement("img"); img.alt=p.name; img.src=p.image || PLACEHOLDER_IMG;
attachProductImageOnError(img, (p && p.name) || '', PLACEHOLDER_IMG);
 img.onerror = ()=> { img.src = PLACEHOLDER_IMG };
            th.appendChild(img); card.appendChild(th);

            const info = document.createElement("div"); info.className="info";
            info.innerHTML = `<div class="name">${p.name}</div><div class="unit">${p.unit}</div><div class="price">${fmt(p.price)}</div>`;
            const acts = document.createElement("div"); acts.className="actions";
            acts.innerHTML = `<div class="qty">
                <div class="icon" data-act="dec" data-key="${key}"><i class="fa-solid fa-minus"></i></div>
                <input class="field" style="width:60px;text-align:center" value="${Cart.data[key]?.qty||0}" data-act="set" data-key="${key}"/>
                <div class="icon" data-act="inc" data-key="${key}"><i class="fa-solid fa-plus"></i></div>
              </div>`;
            acts.querySelector('[data-act="inc"]').onclick = () => Cart.add(p);
            acts.querySelector('[data-act="dec"]').onclick = () => Cart.dec(key);
            acts.querySelector('[data-act="set"]').onchange = (e)=>{ const q=Math.max(0,parseInt(e.target.value||"0",10)); if(!Cart.data[key] && q>0) Cart.data[key]={...p,qty:0}; Cart.set(key,q); };
            info.appendChild(acts); card.appendChild(info); wrap.appendChild(card);
          });
        });
        this.sync();
      },
      sync(){
        const count = Cart.count(); const cc=document.getElementById("cartCount"); if(cc) cc.textContent = `${count} ${count===1?'√≠tem':'√≠tems'}`;
        const ct=document.getElementById("cartTotal"); if(ct) ct.textContent = fmt(Cart.subtotal());
        document.querySelectorAll('input[data-act="set"][data-key]').forEach(inp=>{ const key = inp.getAttribute("data-key"); inp.value = Cart.data[key]?.qty || 0; });
        this.checkoutSync();
      },
      shippingFee(){ return 0; },
      discounts(sub){
        const coupon = (document.getElementById("f_coupon").value||"").trim().toUpperCase();
        let disc = 0;
        if(coupon==="BIENVENIDO10") disc += Math.round(sub*0.10);
        return disc;
      },
      checkoutSync(){
        const mode = document.getElementById("f_mode")?.value || "delivery";
        const row = document.getElementById("rowAddress"); if(row) row.style.display = (mode==="delivery") ? "grid":"none";
        const sub = Cart.subtotal();
        const ship = 0;
        const disc = this.discounts(sub);
        const ssub=document.getElementById("sum_sub"); if(ssub) ssub.textContent = fmt(sub);
        const sdisc=document.getElementById("sum_disc"); if(sdisc) sdisc.textContent = "-" + fmt(disc);
        const stot=document.getElementById("sum_total"); if(stot) stot.textContent = fmt(Math.max(0, sub + ship - disc));

        const pay = document.getElementById("f_payment")?.value || "efectivo";
        const hints = document.getElementById("payHints");
        if(hints){
          if(pay==="transferencia") hints.textContent = "Transferencia: te enviaremos alias/CBU al confirmar.";
          else if(pay==="mercadopago") hints.textContent = "Mercado Pago: te enviaremos un link de pago al confirmar.";
          else hints.textContent = "Efectivo: record√° tener cambio exacto.";
        }
      },
      confirmOrder(){
        if(Cart.count()===0){ toast("Carrito vac√≠o"); return; }
        const order = {
          items: Cart.items(),
          customer: {
            name: document.getElementById("f_name").value.trim(),
            email: document.getElementById("f_email").value.trim(),
            phone: document.getElementById("f_phone").value.trim(),
            mode: document.getElementById("f_mode").value,
            address: document.getElementById("f_address").value.trim(),
            payment: document.getElementById("f_payment").value,
            coupon: (document.getElementById("f_coupon").value||"").trim().toUpperCase()
          },
          totals: {
            subtotal: Cart.subtotal(),
            shipping: this.shippingFee(),
            discount: this.discounts(Cart.subtotal()),
            total: Math.max(0, Cart.subtotal() + this.shippingFee() - this.discounts(Cart.subtotal()))
          },
          createdAt: new Date().toISOString()
        };
        try{ localStorage.setItem("shop_last_order", JSON.stringify(order)) }catch{}
        document.getElementById("orderOk").style.display = "block";
        toast("Pedido confirmado");

        const phone = WHATSAPP_NUMBER.replace(/\D/g,"");
        const lines = order.items.map(it => `‚Ä¢ ${it.name} x${it.qty} ‚Äì ${fmt(toARS(it.price)*it.qty)}`);
        const info = [
          `üë§ ${order.customer.name||"Cliente"}`,
          order.customer.phone ? `üìû ${order.customer.phone}` : "",
          order.customer.mode==="delivery" ? `üöö Delivery` : "üè¨ Retiro en local",
          order.customer.address ? `üìç ${order.customer.address}` : "",
          `üí≥ Pago: ${order.customer.payment}${order.customer.coupon? " ‚Ä¢ Cup√≥n: "+order.customer.coupon : ""}`
        ].filter(Boolean).join("\n");
        const msg = [`*Pedido La Peruana*`, info, `\n*Detalle:*`, lines.join("\n"), `\nSubtotal: ${fmt(order.totals.subtotal)}`, order.totals.discount>0 ? `Descuentos: -${fmt(order.totals.discount)}` : null, `*Total:* ${fmt(order.totals.total)}`].filter(Boolean).join("\n");
        const encoded = encodeURIComponent(msg);
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const urlDesktop = `https://web.whatsapp.com/send?phone=${phone}&text=${encoded}`;
        const urlMobile  = `https://wa.me/${phone}?text=${encoded}`;
        const a = document.createElement("a"); a.href = isMobile ? urlMobile : urlDesktop; a.target="_blank"; a.rel="noopener"; document.body.appendChild(a); a.click(); a.remove();
      }
    };

    // ===== INIT (sin re-declarar UI) =====
    document.addEventListener('DOMContentLoaded', () => UI.init());
  
// Fallback de imagen: intenta repo antes de placeholder
function attachProductImageOnError(imgEl, productName, placeholder) {
  if (!imgEl) return;
  imgEl.onerror = () => {
    const slug = (s) => String(s || "").toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const guess = `${GITHUB_PAGES_BASE}${DEFAULT_IMG_DIR}${slug(productName)}.jpg`;
    if (imgEl.src !== guess) { imgEl.src = guess; return; }
    imgEl.src = placeholder || imgEl.src; // √∫ltimo recurso
  };
}
</script>
</body>
</html>
